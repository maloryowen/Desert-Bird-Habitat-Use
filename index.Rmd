---
title: "Desert Bird Habitat Use"
author: "Malory Owen & Christopher Lortie"
date: "2019"
output:
  html_document:
    toc: true
    toc_float: true
---

# Introduction
Bird community structure in an area changes with the seasons, as birds migrate in Spring to their Summer breeding grounds. During their migration, some will encounter habitats unlike their breeding grounds, allowing for unique interactions between mesohabitat structures. However, some birds are Summer residents of an area, meaning they are traveling *to* a particular area for their breeding season. Lastly, there are also birds that are year long residents, meaning they do not migrate to or from a location. We are investigating the relationship between different migratory classes of birds and the way they interact with available desert mesohabitats. 

Our explanatory variables, which are all metrics for diversity, include:

1. Taxanomic diversity
  + Species
  + Family
  + Order
2. Functional diversity
  + Trophic guild
  + Migratory class

Our response variables, behavior and mesohabitat, include:

1. Behavior
  + Fine behavior
  + Broad behavior
2. Mesohabitat
  + Fine mesohabitat
  + Two level mesohabitat
  + Three level mesohabitat
  + Five level mesohabitat


```{r, libraries, include=FALSE}


library(ggplot2)
library(ggmap)
library(dplyr)
library(ggpubr)
library(tidyverse)
library(vegan)
library(corrplot)
library(distances)
library(codyn)
library(emmeans)
library(lme4)
library(devtools)
library(data.table)
library(MASS)
library(chisq.posthoc.test)



register_google(key="AIzaSyCxOqL_DUpsATBPdDa8HzpWdlIx_wHiSlk")


```


Here, we are examining bird habitat use as it relates to different metrics for diversity (acutal and functional) in a low-anthropogenic-impact, well preserved desert space. 

# Data
## Raw data

```{r, data, echo=FALSE, warning=FALSE}
spring.site <- read.csv("~/Masters/Desert-Bird-Habitat-Use/data/line_transects_flower.csv")

summer.site <- read.csv("~/Masters/Desert-Bird-Habitat-Use/data/line_transects_fruit.csv")

site.all <- read.csv("~/Masters/Desert-Bird-Habitat-Use/data/line_transects.csv")


#Only visuals
site <- read.csv("~/Masters/Desert-Bird-Habitat-Use/data/line_transects_viz.csv")
head(site)

nrow(site[site$season == "summer",])

#summary stats
#taxonomy
unique(site$species)
unique(site$family)
unique(site$order)
#behaviors
unique(site$behavior)
unique(site$broad_behavior)
unique(site$mesohabitat)

```

###Exploration
```{r, EDA, include=FALSE}
season.ssp <- site %>% 
  dplyr::select(season, species) #pull season and species
season.ssp <- as.data.frame(table(season.ssp)) #freq of species in each season

season.tro <- site %>% 
  dplyr::select(season, trophic.guild) #pull season and trophic guild
season.tro <- as.data.frame(table(season.tro))

season.mig <- site %>% 
  dplyr::select(season, migratory.class) #pull season and migratory class
season.mig <- as.data.frame(table(season.mig))


```


## Explanatory Variables 

We need to create a dataset with abundances of levels in each explantory factor per walk.
```{r, explanatory variables dataset, warning=FALSE, include=FALSE}
#get count data for each explanatory variable

#species richness
species.rich <- site %>% 
  dplyr::select(season, walk, species)#pull season, walk, and species
species.rich.long <-  as.data.frame(table(species.rich)) #get freq of each species in long table with walks as rep
species.rich.long$walk <- as.numeric(species.rich.long$walk)
species.rich.wide <- species.rich.long %>% spread(species, Freq) #get into wide format
species.rich.wide$walk <- NULL
species.rich <- as.data.frame(specnumber(species.rich.wide)) #species richness at walk level 
 
#family richness
family.rich <- site %>% 
  dplyr::select(walk, family)#pull walk, and family 
family.rich.long <-  as.data.frame(table(family.rich)) #get freq of each species in long table with walks as rep
family.rich.long$walk <- as.numeric(family.rich.long$walk)
family.rich.wide <- family.rich.long %>% spread(family, Freq) #get into wide format
family.rich.wide$walk <- NULL
family.rich <- as.data.frame(specnumber(family.rich.wide)) #species richness at walk level 

#order richness
order.rich <- site %>% 
  dplyr::select(walk, order)#pull walk, and order
order.rich.long <-  as.data.frame(table(order.rich)) #get freq of each species in long table with walks as rep
order.rich.long$walk <- as.numeric(order.rich.long$walk)
order.rich.wide <- order.rich.long %>% spread(order, Freq) #get into wide format
order.rich.wide$walk <- NULL
order.rich <- as.data.frame(specnumber(order.rich.wide)) #species richness at walk level 

#trophic guild richness
trophic.rich <- site %>% 
  dplyr::select(walk, trophic.guild)#pull walk, and trophic guild
trophic.rich.long <-  as.data.frame(table(trophic.rich)) #get freq of each species in long table with walks as rep
trophic.rich.long$walk <- as.numeric(trophic.rich.long$walk)
trophic.rich.wide <- trophic.rich.long %>% spread(trophic.guild, Freq) #get into wide format
trophic.rich.wide$walk <- NULL
trophic.rich <- as.data.frame(specnumber(trophic.rich.wide)) #species richness at walk level 

#bind together (position is correct) and rename columns
e <- bind_cols(species.rich, family.rich) %>% bind_cols(order.rich, trophic.rich)
colnames(e) <- c("species", "family", "order", "trophic guild") 




#simplifed dataframe with species as explanatory variable, 
ssp.3 <- site %>% 
  dplyr::select(day, season, walk, species, broad.behavior, three.mesohabitat)
#long abundance data
ssp.3.long.frame <- site %>% 
  dplyr::select(season, walk, species)
ssp.3.long <- as.data.frame(table(ssp.3.long.frame))
ssp.3.long$walk <- as.numeric(ssp.3.long$walk)
ssp.3.long <- ssp.3.long %>% filter((season == "spring" & walk < 27) | (season == "summer" & walk > 26))
#wide format for ordinations
ssp.3.wide <- spread(ssp.3.long, species, Freq)



```


##Walk Replications

###Difference in community between seasons at walk level

```{r, community season, warning=FALSE, echo=FALSE}
#walks and species
walks.ssp <- site %>% 
  dplyr::select(season, walk, species)#pull season, walk, and species
walks.ssp.long <-  as.data.frame(table(walks.ssp)) #get freq of each species in long table with walks as rep
write.csv(walks.ssp.long,"~/Masters/Desert-Bird-Habitat-Use/output_data/walks.ssp.long.csv", row.names = FALSE) #write to csv
walks.ssp.wide <- walks.ssp.long %>% spread(species, Freq) #get species into wide format
walks.ssp.wide$walk <- as.numeric(walks.ssp.wide$walk) #make walks numeric
walks.ssp.wide <- filter(walks.ssp.wide, (season == "spring" & walk < 27) | (season == "summer" & walk > 26)) #filter so only 1-26 of springing season and 27-47 for summering season are present
walks.ssp.wide$season <- NULL #remove season
walks.ssp.wide$walk <- NULL #remove walks 
#must remove factors so that we can calculate diversity metrics later


#season walks and species
community.season <- site %>% 
  dplyr::select(season, walk, species) #columns of interest
community.season.long <- as.data.frame(table(community.season)) #long with frequencies
community.season.long$walk <- as.numeric(community.season.long$walk)
community.season.wide <- community.season.long %>% spread(season, Freq) #incorrect

#species abundaces only for each season by walk
#spring
ssp.spring <- ssp.3.wide %>% filter(season == "spring") 
ssp.spring$season <- NULL
ssp.spring$walk <- NULL
  
ssp.summer <- ssp.3.wide %>% filter(season == "summer")
ssp.summer$season <- NULL
ssp.summer$walk <- NULL



```

### Multiple metrics of community structure

I'd like to see the different metrics for community structure that ecologists use, so I need to create a dataset of all of these values, with "walk" as the replication level
```{r, community metrics, warning=FALSE, include=FALSE}
#covariates environmental data
cov <-  as.data.frame(table(ssp.3$walk, ssp.3$season)) #environmental data of all covariates in long format, for all community metrics to be added to
colnames(cov) <- c("walk","season", "abundance") #rename columns
cov$walk <- as.numeric(cov$walk) #make walk numeric
cov <- filter(cov, (season == "spring" & walk < 27) | (season == "summer" & walk > 26))


#Diversity metrics
#richness
S <- as.data.frame(specnumber(walks.ssp.wide)) #species richness at walk level 

#shannons diversity
H <- as.data.frame(diversity(walks.ssp.wide))

#simpsons diversity
simp <- as.data.frame(diversity(walks.ssp.wide, "simpson"))

#evenness
J <- as.data.frame(H/log(S)) #NaN are walks with a species richness of 1, but go ahead and ignore (find out threshold 2-5%) and leave in unless there's too many


#turnover
#calculates total turnover, appearances, and disappearences
turnover <- turnover(df = community.season.long, 
                    time.var = "walk", 
                    species.var = "species", 
                    abundance.var = "Freq", 
                    replicate.var = "season")
turnover$season <- NULL

#Give each metric a "walk" column so it can be joined together in cov dataset
S$walk <- rownames(S) %>% as.numeric(S$walk)
H$walk <- rownames(H) %>% as.numeric(H$walk)
simp$walk <-rownames(simp) %>% as.numeric(simp$walk)
J$walk <- rownames(J) %>% as.numeric(J$walk)


#joining to combine our new diversity stats
cov <- cov %>% left_join(H, by = "walk") %>% left_join(S, by = "walk") %>% left_join(simp, by = "walk") %>% left_join(J, by = "walk") %>% left_join(turnover, by = "walk") 

#rename cov columns
colnames(cov) <- c("walk","season", "abundance", "shannon", "richness", "simpson", "evenness", "turnover") 



cov$evenness[is.na(cov$evenness)] = 0 #make NaN's into 1's


```


##Taxonomic Diversity

### Difference in mesohabitat between seasons 
Here, we will treat each species type as a replicate, as we aren't interested in which species, but rather if there is a difference at all. We will do the same with the funcitonal diversity.

First, let's make a 3-level mesohabitat
```{r, community differences at mesohabitat 3 level, warning=FALSE}
#for both seasons
#mesos and species
meso.ssp <- site[,c(4, 5, 19, 12)] #pull season, mesohabitat, and species
meso.ssp.long.3 <-  as.data.frame(table(meso.ssp)) #get freq of each species in long table with
meso.ssp.long.3 <- mutate(meso.ssp.long.3, meso = paste(three.mesohabitat, season))
meso.ssp.long.3$three.mesohabitat <- NULL
write.csv(meso.ssp.long.3,"~/Masters/Desert-Bird-Habitat-Use/output_data/meso.ssp.long.3.csv", row.names = FALSE)


meso3 <- meso.ssp.long.3 %>% spread(meso, Freq) #data can be used in an ANoVA

#for just spring
meso.ssp <- site[,c(4, 5, 19, 12)] #pull season, mesohabitat, and species
meso.ssp.long.3.sp <-  as.data.frame(table(meso.ssp))
meso.ssp.long.3.sp <- filter(meso.ssp.long.3.sp, season == "spring")

#for just summer
meso.ssp <- site[,c(4, 5, 19, 12)] #pull season, mesohabitat, and species
meso.ssp.long.3.su <-  as.data.frame(table(meso.ssp))
meso.ssp.long.3.su <- filter(meso.ssp.long.3.su, season == "summer")

```


Next, let's prepare the data for when we check and see if the number of levels of mesohabitat type is important. Same code, just a different column. Here, we're doing a 2-level mesohabitat
```{r, community difference a mesohabitat 2 level, warning=FALSE, echo=FALSE}

#mesos and species
meso.ssp <- site[,c(4, 5, 18, 12)] #pull season, mesohabitat, and species
meso.ssp.long.2 <-  as.data.frame(table(meso.ssp)) #get freq of each species in long table with
meso.ssp.long.2 <- mutate(meso.ssp.long.2, meso = paste(two.mesohabitat, season))
meso.ssp.long.2$two.mesohabitat <- NULL
write.csv(meso.ssp.long.2,"~/Masters/Desert-Bird-Habitat-Use/output_data/meso.ssp.long.2.csv", row.names = FALSE)

meso2 <- meso.ssp.long.2 %>% spread(meso, Freq) #data can be used in an ANoVA

#for just spring
meso.ssp <- site[,c(4, 18, 12)] #pull season, mesohabitat, and species
meso.ssp.long.2.sp <-  as.data.frame(table(meso.ssp))
meso.ssp.long.2.sp <- filter(meso.ssp.long.2.sp, season == "spring")

#for just summer
meso.ssp <- site[,c(4, 18, 12)] #pull season, mesohabitat, and species
meso.ssp.long.2.su <-  as.data.frame(table(meso.ssp))
meso.ssp.long.2.su <- filter(meso.ssp.long.2.su, season == "summer")

```


###Differences in behavior between seasons
```{r}

#broad behavior and species
#both seasons together
beha.ssp <- site[,c(4, 5, 16, 12)] #pull season, broad behavior, and species
beha.ssp.long.4box <-  as.data.frame(table(beha.ssp)) #get freq of each species in long table with
beha.ssp.long <- mutate(beha.ssp.long.4box, behavior = paste(broad.behavior, season))
 #combine behavior type and season so that distinct variables
beha.ssp.long$broad.behavior <- NULL
write.csv(beha.ssp.long,"~/Masters/Desert-Bird-Habitat-Use/output_data/beha.ssp.long.csv", row.names = FALSE)



behavior <- beha.ssp.long %>% spread(behavior, Freq) #data can be used in an ANoVA

#spring only
beha.ssp <- site[,c(4, 16, 12)] #pull season, broad behavior, and species
beha.ssp.long.sp <-  as.data.frame(table(beha.ssp))
beha.ssp.long.sp <- filter(beha.ssp.long.sp, season == "spring")

#summer only
beha.ssp <- site[,c(4, 16, 12)] #pull season, broad behavior, and species
beha.ssp.long.su <-  as.data.frame(table(beha.ssp))
beha.ssp.long.su <- filter(beha.ssp.long.su, season == "summer")


```


##Functional Diversity

Functional diversity has two metrics: trophic guilds and migratory classes. We need to explore both.

### Difference in mesohabitat between seasons 

####Trophic Guilds
First, let's make a 3-level mesohabitat
```{r, community differences at mesohabitat 3 level, warning=FALSE}
#for both seasons
#mesos and tropic guilds
meso.tro <- site[,c(4, 5, 19, 14)] #pull season, mesohabitat, and species
meso.tro.long.3 <-  as.data.frame(table(meso.tro)) #get freq of each species in long table with
meso.tro.long.3 <- mutate(meso.tro.long.3, meso = paste(three.mesohabitat, season))
meso.tro.long.3$season <- NULL #combine mesohabitat and season so that distinct variables
meso.tro.long.3$three.mesohabitat <- NULL
write.csv(meso.tro.long.3,"~/Masters/Desert-Bird-Habitat-Use/output_data/meso.tro.long.csv", row.names = FALSE)


meso3 <- meso.tro.long.3 %>% spread(meso, Freq) #data can be used in an ANoVA

#for just spring
meso.tro <- site[,c(4, 19, 14)] #pull season, mesohabitat, and species
meso.tro.long.3.sp <-  as.data.frame(table(meso.tro))
meso.tro.long.3.sp <- filter(meso.tro.long.3.sp, season == "spring")

#for just summer
meso.tro <- site[,c(4, 19, 14)] #pull season, mesohabitat, and species
meso.tro.long.3.su <-  as.data.frame(table(meso.tro))
meso.tro.long.3.su <- filter(meso.tro.long.3.su, season == "summer")

```

Next, let's prepare the data for when we check and see if the number of levels of mesohabitat type is important. Same code, just a different column. Here, we're doing a 2-level mesohabitat
```{r, community difference a mesohabitat 2 level, warning=FALSE, echo=FALSE}

#mesos and species
meso.tro <- site[,c(4, 18, 14)] #pull season, mesohabitat, and trophic guild
meso.tro.long.2 <-  as.data.frame(table(meso.tro)) #get freq of each species in long table with
meso.tro.long.2 <- mutate(meso.tro.long.2, meso = paste(two.mesohabitat, season))
meso.tro.long.2$season <- NULL #combine mesohabitat and season so that distinct variables
meso.tro.long.2$two.mesohabitat <- NULL

meso2 <- meso.tro.long.2 %>% spread(meso, Freq) #data can be used in an ANoVA

#for just spring
meso.tro <- site[,c(4, 18, 14)] #pull season, mesohabitat, and species
meso.tro.long.2.sp <-  as.data.frame(table(meso.tro))
meso.tro.long.2.sp <- filter(meso.tro.long.2.sp, season == "spring")

#for just summer
meso.tro <- site[,c(4, 18, 14)] #pull season, mesohabitat, and species
meso.tro.long.2.su <-  as.data.frame(table(meso.tro))
meso.tro.long.2.su <- filter(meso.tro.long.2.su, season == "summer")

```


####Migratory Classes
First, let's make a 3-level mesohabitat
```{r, community differences at mesohabitat 3 level, warning=FALSE}
#for both seasons
#mesos and migratory classes
meso.mig <- site[,c(4, 5, 19, 13)] #pull season, mesohabitat, and migratory class
meso.mig.long.3 <-  as.data.frame(table(meso.mig)) #get freq of each mig class in long table with
meso.mig.long.3 <- mutate(meso.mig.long.3, meso = paste(three.mesohabitat, season))
meso.mig.long.3$season <- NULL #combine mesohabitat and season so that distinct variables
meso.mig.long.3$three.mesohabitat <- NULL
write.csv(meso.mig.long,"~/Masters/Desert-Bird-Habitat-Use/output_data/meso.mig.long.csv", row.names = FALSE)



meso3 <- meso.mig.long.3 %>% spread(meso, Freq) #data can be used in an ANoVA

#for just spring
meso.mig <- site[,c(4, 19, 13)] #pull season, mesohabitat, and migratory class
meso.mig.long.3.sp <-  as.data.frame(table(meso.mig))
meso.mig.long.3.sp <- filter(meso.mig.long.3.sp, season == "spring")

#for just summer
meso.mig <- site[,c(4, 19, 13)] #pull season, mesohabitat, and migratory class
meso.mig.long.3.su <-  as.data.frame(table(meso.mig))
meso.mig.long.3.su <- filter(meso.mig.long.3.su, season == "summer")

```

Next, let's prepare the data for when we check and see if the number of levels of mesohabitat type is important. Same code, just a different column. Here, we're doing a 2-level mesohabitat
```{r, community difference a mesohabitat 2 level, warning=FALSE, echo=FALSE}

#mesos and species
meso.mig <- site[,c(4, 18, 13)] #pull season, mesohabitat, and migratory class
meso.mig.long.2 <-  as.data.frame(table(meso.mig)) #get freq of each species in long table with
meso.mig.long.2 <- mutate(meso.mig.long.2, meso = paste(two.mesohabitat, season))
meso.mig.long.2$season <- NULL #combine mesohabitat and season so that distinct variables
meso.mig.long.2$two.mesohabitat <- NULL

meso2 <- meso.mig.long.2 %>% spread(meso, Freq) #data can be used in an ANoVA

#for just spring
meso.mig <- site[,c(4, 18, 13)] #pull season, mesohabitat, and migratory class
meso.mig.long.2.sp <-  as.data.frame(table(meso.mig))
meso.mig.long.2.sp <- filter(meso.tro.long.2.sp, season == "spring")

#for just summer
meso.mig <- site[,c(4, 18, 13)] #pull season, mesohabitat, and migratory class
meso.mig.long.2.su <-  as.data.frame(table(meso.mig))
meso.mig.long.2.su <- filter(meso.mig.long.2.su, season == "summer")

```




### Difference in behavior between seasons 
####Trophic Guilds
```{r, trophic guild data, warning=FALSE, include=FALSE}
beha.tro <- site[,c(4, 5, 16, 14)] #pull season, mesohabitat, and trophic guild
beha.tro.long.4box <-  as.data.frame(table(beha.tro)) #get freq of each trophic guild in long table with
beha.tro.long <- mutate(beha.tro.long.4box, behavior = paste(broad.behavior, season))
beha.tro.long$season <- NULL #combine mesohabitat and season so that distinct variables
beha.tro.long$broad.behavior <- NULL
write.csv(beha.tro.long,"~/Masters/Desert-Bird-Habitat-Use/output_data/beha.tro.long.csv", row.names = FALSE)


behavior <- beha.tro.long %>% spread(behavior, Freq) #data can be used in an ANoVA

#spring only
beha.tro <- site[,c(4, 16, 14)] #pull season, broad behavior, and species
beha.tro.long.sp <-  as.data.frame(table(beha.tro))
beha.tro.long.sp <- filter(beha.tro.long.sp, season == "spring")

#summer only
beha.tro <- site[,c(4, 16, 14)] #pull season, broad behavior, and species
beha.tro.long.su <-  as.data.frame(table(beha.tro))
beha.tro.long.su <- filter(beha.tro.long.su, season == "summer")

```


####Migratory Classes
```{r, trophic guild data, warning=FALSE, include=FALSE}
beha.mig <- site[,c(4, 5, 16, 13)] #pull season, mesohabitat, and trophic guild
beha.mig.long.4box <-  as.data.frame(table(beha.mig)) #get freq of each trophic guild in long table with
beha.mig.long <- mutate(beha.mig.long.4box, behavior = paste(broad.behavior, season))
beha.mig.long$season <- NULL #combine mesohabitat and season so that distinct variables
beha.mig.long$broad.behavior <- NULL
write.csv(beha.mig.long,"~/Masters/Desert-Bird-Habitat-Use/output_data/beha.mig.long.csv", row.names = FALSE)


behavior <- beha.mig.long %>% spread(behavior, Freq) #data can be used in an ANoVA

#spring only
beha.mig <- site[,c(4, 16, 13)] #pull season, broad behavior, and species
beha.mig.long.sp <-  as.data.frame(table(beha.mig))
beha.mig.long.sp <- filter(beha.mig.long.sp, season == "spring")

#summer only
beha.mig <- site[,c(4, 16, 13)] #pull season, broad behavior, and species
beha.mig.long.su <-  as.data.frame(table(beha.mig))
beha.mig.long.su <- filter(beha.mig.long.su, season == "summer")

```


###Influence of mesohabitat on behavior 

First, let's do three-level mesohabitat
```{r, meso influence beha data, warning=FALSE, include=FALSE}
#three level
cont1 <- site[,c(4, 12, 16, 19)]
cont <- as.data.frame(table(cont1$three.mesohabitat, cont1$broad.behavior)) 
cont <- cont %>% spread(Var1, Freq)
cont <- column_to_rownames(cont, var="Var2") #ready for chi squared test


#spring
cont.sp <- filter(cont1, season == "spring")
cont.sp <- as.data.frame(table(cont.sp$three.mesohabitat, cont.sp$broad.behavior))
cont.sp <- cont.sp %>% spread(Var1, Freq)
cont.sp <- column_to_rownames(cont.sp, var="Var2")

#summer
cont.su <- filter(cont1, season == "summer")
cont.su <- as.data.frame(table(cont.su$three.mesohabitat, cont.su$broad.behavior))
cont.su <- cont.su %>% spread(Var1, Freq)
cont.su <- column_to_rownames(cont.su, var="Var2")


```


# Viz

## Maps

```{r, map, warning=FALSE}
#map of all bird sitings
deep.sunset <- get_map(location = c(lon = -115.663, lat = 34.7805), zoom = 17, color="bw")

site.wide.map <- ggmap(deep.sunset)
site.wide.map <- site.wide.map +
  geom_point(data=site, aes(x=lon, y=lat, colour = order, group = order), alpha = 3/10, size =4) +
  labs(title = "Site Wide Species Observations", x = "longitude", y = "latitude", color = "Order")
site.wide.map
```


## Histograms

```{r, Histograms, warning=FALSE, echo=FALSE}
#behaviors
#behaviors
hist.behavior <- ggplot(site, aes(x=broad.behavior, fill = as.factor(season))) + 
  geom_histogram(stat="count") + 
  facet_grid(.~season) +
  scale_fill_manual(values = c("#FFF47F", "#7FB2FF")) +
  theme_classic() + 
  labs(x = "Behavior Type", y = "Frequency of Behavior") +
  theme(legend.title = element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust =1, size=12)) +
  theme(strip.text.x = element_blank()) 
hist.behavior


#mesohabitats

#Five level mesohabitats
hist.mesofive <- ggplot(site, aes(x=five.mesohabitat, fill = as.factor(season))) + 
  geom_histogram(stat="count") + 
  facet_grid(.~season) + 
  scale_fill_manual(values = c("#FFF47F", "#7FB2FF")) +
  theme_classic() + 
  labs(x = "Mesohabitat Type", y = "Frequency of Mesohabitat") +
  theme(legend.title = element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=12)) +
  theme(strip.text.x = element_blank()) 


#Three level mesohabitats
hist.mesothree <- ggplot(site, aes(x=three.mesohabitat, fill=as.factor(season))) + 
  geom_histogram(stat="count") + 
  facet_grid(.~season) + 
  scale_fill_manual(values = c("#FFF47F", "#7FB2FF")) +
  theme_classic() + 
  labs(x = "Mesohabitat Type", y = "Frequency of Mesohabitat") +
  theme(legend.title = element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=12)) +
  theme(strip.text.x = element_blank()) 


#Two level mesohabitats
hist.mesotwo <- ggplot(site, aes(x=two.mesohabitat, fill = as.factor(season))) + 
  geom_histogram(stat="count") + 
  facet_grid(.~season) + 
  scale_fill_manual(values = c("#FFF47F", "#7FB2FF")) +
  theme_classic() + 
  labs(x = "Mesohabitat Type", y = "Frequency of Mesohabitat") +
  theme(legend.title = element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=12)) +
  theme(strip.text.x = element_blank()) 


#histogram mesohabitats 
hist.meso <- ggarrange(hist.mesofive, hist.mesothree, hist.mesotwo, ncol=2, nrow=2) 
hist.meso

#diversity histograms
#order
hist.order <- ggplot(site, aes(x=order, fill = as.factor(season))) + 
  geom_histogram(stat="count") +
  facet_grid(.~season) +
  scale_fill_manual(values = c("#FFF47F", "#7FB2FF")) +
  theme_classic() + 
  labs(x = "Order", y = "Frequency of Order") +
  theme(legend.title = element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=12)) +
  theme(strip.text.x = element_blank())

#trophic
hist.trophic <- ggplot(site, aes(x=trophic.guild, fill = as.factor(season))) + 
  geom_histogram(stat="count") +
  facet_grid(.~season) +
  scale_fill_manual(values = c("#FFF47F", "#7FB2FF")) +
  theme_classic() + 
  labs(x = "Trophic Guild", y = "Frequency of Trophic Guild") +
  theme(legend.title = element_blank()) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=12)) +
  theme(strip.text.x = element_blank())

#migratory class
hist.mig <- ggplot(site, aes(x=migratory.class, fill = as.factor(season))) + 
  geom_histogram(stat="count") +
  facet_grid(.~season) +
  scale_fill_manual(values = c("#FFF47F", "#7FB2FF")) +
  theme_classic() + 
  labs(x = "Migratory Class", y = "Frequency of Migratory Class") +
  theme(legend.title = element_blank()) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=12)) +
  theme(strip.text.x = element_blank())

#diversity histograms together
hist.div <- ggarrange(hist.trophic, hist.order, hist.mig, ncol=2, nrow=2)
hist.div

#histogram of bird distance from transect
hist.dist <- ggplot(site, aes(x=distance, fill = as.factor(season))) + 
  geom_histogram(stat="count") +
  facet_grid(.~season) +
  scale_fill_manual(values = c("#FFF47F", "#7FB2FF")) +
  theme_classic() + 
  labs(x = "Distance", y = "Frequency of Distances") +
  theme(legend.title = element_blank()) +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size=12)) +
  theme(strip.text.x = element_blank())
hist.dist

```



## Community Structure Metrics

Here we will visualize some standard metrics of community structure. These metrics include Shannon Weaver Indices, Simpson's Diversity Indices, Abudances, Richness, Evenness, and Turnover.

### Distributions 

```{r, comm dist, warning=FALSE, echo=FALSE}
abun.dist <- ggplot(cov, aes(x=abundance)) +
  geom_density() +
  theme_classic() + 
  theme(axis.title.y = element_blank()) +
  labs(x = "Abundance")

shan.dist <- ggplot(cov, aes(x=shannon)) +
  geom_density() +
  theme_classic() + 
  theme(axis.title.y = element_blank()) +
  labs(x = "Shannon's Diversity")

rich.dist <- ggplot(cov, aes(x=richness)) +
  geom_density() +
  theme_classic() + 
  theme(axis.title.y = element_blank()) +
  labs(x = "Richness")

simp.dist <- ggplot(cov, aes(x=simpson)) +
  geom_density() +
  theme_classic() + 
  theme(axis.title.y = element_blank()) +
  labs(x = "Simpson's Diversity")

even.dist <- ggplot(cov, aes(x=evenness)) +
  geom_density() +
  theme_classic() + 
  theme(axis.title.y = element_blank()) +
  labs(x = "Evenness")

turn.dist <- ggplot(cov, aes(x=turnover)) +
  geom_density() +
  theme_classic() + 
  theme(axis.title.y = element_blank()) +
  labs(x = "Turnover")

comm.dist <- ggarrange(abun.dist, shan.dist, rich.dist, simp.dist, even.dist, turn.dist, ncol=2, nrow=3)
comm.dist
```


### Boxplots of Community Structure Metrics between Seasons

```{r, boxplots, echo=FALSE, warning=FALSE}
shan.box <- ggplot(cov, aes(x=season, y=shannon, color = season, fill = season)) +
  geom_boxplot() +
  theme_classic(base_size=15) +
  scale_color_brewer(palette = "Set1") +
  scale_fill_manual(values=c("#DAF7A6", "#FFD156")) +
  theme(legend.position="none") +
  theme(axis.title.x=element_blank()) +
  labs(y = "Shannon's Diversity", x=" ") +
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

abun.box <- ggplot(cov, aes(x=season, y=abundance, color = season, fill = season)) +
  geom_boxplot() +
  theme_classic(base_size=15) +
  scale_color_brewer(palette = "Set1") +
  theme(axis.text.x = element_text(size=15)) +
  scale_fill_manual(values=c("#DAF7A6", "#FFD156")) +
  theme(legend.position="none") +
  theme(axis.title.x=element_blank()) +
  labs(y = "Abundance", x=" ") +
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

rich.box <- ggplot(cov, aes(x=season, y=richness, color = season, fill = season)) +
  geom_boxplot() +
  theme_classic(base_size=15) +
  scale_color_brewer(palette = "Set1") +
  theme(axis.text.x = element_text(size=15)) +
  scale_fill_manual(values=c("#DAF7A6", "#FFD156")) +
  theme(legend.position="none") +
  theme(axis.title.x=element_blank()) +
  labs(y = "Richness") 

simp.box <- ggplot(cov, aes(x=season, y=simpson, color = season, fill = season)) +
  geom_boxplot() +
  theme_classic(base_size=15) +
  scale_color_brewer(palette = "Set1") +
  theme(axis.text.x = element_text(size=15)) +
  scale_fill_manual(values=c("#DAF7A6", "#FFD156")) +
  theme(legend.position="none") +
  theme(axis.title.x=element_blank()) +
  labs(y = "Simpson's Diversity", x = " ") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

even.box <- ggplot(cov, aes(x=season, y=evenness, color = season, fill = season)) +
  geom_boxplot() +
  theme_classic(base_size=15) +
  scale_color_brewer(palette = "Set1") +
  theme(axis.text.x = element_text(size=15)) +
  scale_fill_manual(values=c("#DAF7A6", "#FFD156")) +
  theme(legend.position="none") +
  theme(axis.title.x=element_blank()) +
  labs(y = "Evenness")

turn.box <- ggplot(cov, aes(x=season, y=turnover, color = season, fill = season)) +
  geom_boxplot() +
  theme_classic(base_size=15) +
  scale_color_brewer(palette = "Set1") +
  theme(axis.text.x = element_text(size=15)) +
  scale_fill_manual(values=c("#DAF7A6", "#FFD156")) +
  theme(legend.position="none") +
  theme(axis.title.x=element_blank()) +
  labs(y = "Turnover")

comm.box <- ggarrange(shan.box, simp.box, abun.box, rich.box, even.box, turn.box, nrow=3, ncol=2)
comm.box

```

####Bargraphs of Mesohabitat and Behavioral species frequency
```{r, behavioral boxplot, echo=FALSE}
#mesohabitat 
#three level
meso.ssp.summary.3 <- data.frame(
    mean=tapply(meso.ssp.long.3$Freq, meso.ssp.long.3$meso, mean),
    n=tapply(meso.ssp.long.3$Freq, meso.ssp.long.3$meso, length),
    sd=tapply(meso.ssp.long.3$Freq, meso.ssp.long.3$meso, sd)
    )
meso.ssp.summary.3 <- setDT(meso.ssp.summary.3, keep.rownames = TRUE)[]

meso.ssp.summary.3 <- separate(meso.ssp.summary.3, rn, 'mesohabitat', sep = " ", remove = FALSE)

meso.ssp.summary.3$rn <-  gsub('cactus ', ' ', meso.ssp.summary.3$rn)
meso.ssp.summary.3$rn <-  gsub('shrub ', ' ', meso.ssp.summary.3$rn)
meso.ssp.summary.3$rn <-  gsub('other ', ' ', meso.ssp.summary.3$rn)


meso.ssp.bar.3 <- ggplot(meso.ssp.summary.3, aes(x=mesohabitat, y=mean, fill=rn, position_dodge())) +
  geom_bar(stat = "summary", position = "dodge") +
  geom_errorbar(aes(ymin=0, ymax=mean+sd), position=position_dodge(.9), width = 0) +
  theme_classic() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(size=15)) +
  scale_fill_manual(values=c("#FFB64C", "#B1E7C7")) +
  theme(axis.title.x=element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = .5, vjust = 0.5)) +
  labs(title = "A", y = "Mean Frequency") +
  theme(legend.title = element_blank()) +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 1))
meso.ssp.bar.3

#two level
meso.ssp.summary.2 <- data.frame(
    mean=tapply(meso.ssp.long.2$Freq, meso.ssp.long.2$meso, mean),
    n=tapply(meso.ssp.long.2$Freq, meso.ssp.long.2$meso, length),
    sd=tapply(meso.ssp.long.2$Freq, meso.ssp.long.2$meso, sd)
    )
meso.ssp.summary.2 <- setDT(meso.ssp.summary.2, keep.rownames = TRUE)[]

meso.ssp.summary.2 <- separate(meso.ssp.summary.2, rn, 'mesohabitat', sep = " ", remove = FALSE)

meso.ssp.summary.2$rn <-  gsub('non-vegetative ', ' ', meso.ssp.summary.2$rn)
meso.ssp.summary.2$rn <-  gsub('vegetative ', ' ', meso.ssp.summary.2$rn)

meso.ssp.bar.2 <- ggplot(meso.ssp.summary.2, aes(x=mesohabitat, y=mean, fill=rn, position_dodge())) +
  geom_bar(stat = "summary", position = "dodge") +
  geom_errorbar(aes(ymin=0, ymax=mean+sd), position=position_dodge(.9), width = 0) +
  theme_classic() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(size=15)) +
  scale_fill_manual(values=c("#FFB64C", "#B1E7C7")) +
  theme(axis.title.x=element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = .5, vjust = 0.5)) +
  labs(y = "Mean Frequency") +
  theme(legend.title = element_blank()) +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 1))
meso.ssp.bar.2

#behavior
beha.ssp.summary <- data.frame(
    mean=tapply(beha.ssp.long$Freq, beha.ssp.long$behavior, mean),
    n=tapply(beha.ssp.long$Freq, beha.ssp.long$behavior, length),
    sd=tapply(beha.ssp.long$Freq, beha.ssp.long$behavior, sd)
    )
beha.ssp.summary <- setDT(beha.ssp.summary, keep.rownames = TRUE)[]

beha.ssp.summary <- separate(beha.ssp.summary, rn, 'behavior', sep = " ", remove = FALSE)

beha.ssp.summary$rn <-  gsub('Active movement ', ' ', beha.ssp.summary$rn)
beha.ssp.summary$rn <-  gsub('Cleaning ', ' ', beha.ssp.summary$rn)
beha.ssp.summary$rn <-  gsub('Feeding ', ' ', beha.ssp.summary$rn)
beha.ssp.summary$rn <-  gsub('Inactivity ', ' ', beha.ssp.summary$rn)
beha.ssp.summary$rn <-  gsub('Territorial/mating ', ' ', beha.ssp.summary$rn)

beha.ssp.bar <- ggplot(beha.ssp.summary, aes(x=behavior, y=mean, fill=rn, position_dodge())) +
  geom_bar(stat = "summary", position = "dodge") +
  geom_errorbar(aes(ymin=0, ymax=mean+sd), position=position_dodge(.9), width = 0) +
  theme_classic() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(size=15)) +
  scale_fill_manual(values=c("#FFB64C", "#B1E7C7")) +
  theme(legend.title = element_blank()) +
  theme(axis.title.x=element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = .5, vjust = 0.5)) +
  labs(y = "Mean Frequency") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 1))
beha.ssp.bar


ssp.bar <- ggarrange(meso.ssp.bar.3, beha.ssp.bar, nrow=1, ncol=2)
```

####Bar graphs of mesohabitat and behavior frequency trophic guild
```{r, behavioral boxplot, echo=FALSE}
#mesohabitat 
#three level
meso.tro.summary.3 <- data.frame(
    mean=tapply(meso.tro.long.3$Freq, meso.tro.long.3$meso, mean),
    n=tapply(meso.tro.long.3$Freq, meso.tro.long.3$meso, length),
    sd=tapply(meso.tro.long.3$Freq, meso.tro.long.3$meso, sd)
    )
meso.tro.summary.3 <- setDT(meso.tro.summary.3, keep.rownames = TRUE)[]

meso.tro.summary.3 <- separate(meso.tro.summary.3, rn, 'mesohabitat', sep = " ", remove = FALSE)

meso.tro.summary.3$rn <-  gsub('cactus ', ' ', meso.tro.summary.3$rn)
meso.tro.summary.3$rn <-  gsub('shrub ', ' ', meso.tro.summary.3$rn)
meso.tro.summary.3$rn <-  gsub('other ', ' ', meso.tro.summary.3$rn)


meso.tro.bar.3 <- ggplot(meso.tro.summary.3, aes(x=mesohabitat, y=mean, fill=rn, position_dodge())) +
  geom_bar(stat = "summary", position = "dodge") +
  geom_errorbar(aes(ymin=0, ymax=mean+sd), position=position_dodge(.9), width = 0) +
  theme_classic() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(size=15)) +
  scale_fill_manual(values=c("#FFB64C", "#B1E7C7")) +
  theme(axis.title.x=element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = .5, vjust = 0.5)) +
  labs(title = "B") +
  theme(legend.title = element_blank())  +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 1))
meso.tro.bar.3

#two level
meso.tro.summary.2 <- data.frame(
    mean=tapply(meso.tro.long.2$Freq, meso.tro.long.2$meso, mean),
    n=tapply(meso.tro.long.2$Freq, meso.tro.long.2$meso, length),
    sd=tapply(meso.tro.long.2$Freq, meso.tro.long.2$meso, sd)
    )
meso.tro.summary.2 <- setDT(meso.tro.summary.2, keep.rownames = TRUE)[]

meso.tro.summary.2 <- separate(meso.tro.summary.2, rn, 'mesohabitat', sep = " ", remove = FALSE)

meso.tro.summary.2$rn <-  gsub('vegetative ', ' ', meso.tro.summary.2$rn)
meso.tro.summary.2$rn <-  gsub('non-vegetative ', ' ', meso.tro.summary.2$rn)

meso.tro.bar.2 <- ggplot(meso.tro.summary.2, aes(x=mesohabitat, y=mean, fill=rn, position_dodge())) +
  geom_bar(stat = "summary", position = "dodge") +
  geom_errorbar(aes(ymin=0, ymax=mean+sd), position=position_dodge(.9), width = 0) +
  theme_classic() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(size=15)) +
  scale_fill_manual(values=c("#FFB64C", "#B1E7C7", "#FFB64C", "#B1E7C7")) +
  theme(axis.title.x=element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = .5, vjust = 0.5)) +
  labs(y = " ") +
  theme(legend.title = element_blank()) +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 1))
meso.tro.bar.2

#behavior
beha.tro.summary <- data.frame(
    mean=tapply(beha.tro.long$Freq, beha.tro.long$behavior, mean),
    n=tapply(beha.tro.long$Freq, beha.tro.long$behavior, length),
    sd=tapply(beha.tro.long$Freq, beha.tro.long$behavior, sd)
    )
beha.tro.summary <- setDT(beha.tro.summary, keep.rownames = TRUE)[]

beha.tro.summary <- separate(beha.tro.summary, rn, 'behavior', sep = " ", remove = FALSE)

beha.tro.summary$rn <-  gsub('Active movement ', ' ', beha.tro.summary$rn)
beha.tro.summary$rn <-  gsub('Cleaning ', ' ', beha.tro.summary$rn)
beha.tro.summary$rn <-  gsub('Feeding ', ' ', beha.tro.summary$rn)
beha.tro.summary$rn <-  gsub('Inactivity ', ' ', beha.tro.summary$rn)
beha.tro.summary$rn <-  gsub('Territorial/mating ', ' ', beha.tro.summary$rn)

beha.tro.bar <- ggplot(beha.tro.summary, aes(x=behavior, y=mean, fill=rn, position_dodge())) +
  geom_bar(stat = "summary", position = "dodge") +
  geom_errorbar(aes(ymin=0, ymax=mean+sd), position=position_dodge(.9), width = 0) +
  theme_classic() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(size=15)) +
  scale_fill_manual(values=c("#FFB64C", "#B1E7C7")) +
  theme(legend.title = element_blank()) +
  theme(axis.title.x=element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = .5, vjust = 0.5)) +
  labs(y = " ") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 1))
beha.tro.bar


tro.bar <- ggarrange(meso.tro.bar.3, beha.tro.bar, nrow=1, ncol=2)
```


####Bar graphs of mesohabitat and behavior frequency migratory class
```{r, behavioral boxplot, echo=FALSE}
#mesohabitat 
#three level
meso.mig.summary.3 <- data.frame(
    mean=tapply(meso.mig.long.3$Freq, meso.mig.long.3$meso, mean),
    n=tapply(meso.mig.long.3$Freq, meso.mig.long.3$meso, length),
    sd=tapply(meso.mig.long.3$Freq, meso.mig.long.3$meso, sd)
    )
meso.mig.summary.3 <- setDT(meso.mig.summary.3, keep.rownames = TRUE)[]

meso.mig.summary.3 <- separate(meso.mig.summary.3, rn, 'mesohabitat', sep = " ", remove = FALSE)

meso.mig.summary.3$rn <-  gsub('cactus ', ' ', meso.mig.summary.3$rn)
meso.mig.summary.3$rn <-  gsub('shrub ', ' ', meso.mig.summary.3$rn)
meso.mig.summary.3$rn <-  gsub('other ', ' ', meso.mig.summary.3$rn)


meso.mig.bar.3 <- ggplot(meso.mig.summary.3, aes(x=mesohabitat, y=mean, fill=rn, position_dodge())) +
  geom_bar(stat = "summary", position = "dodge") +
  geom_errorbar(aes(ymin=0, ymax=mean+sd), position=position_dodge(.9), width = 0) +
  theme_classic() +
  theme(legend.title = element_blank()) +
  theme(axis.text.x = element_text(size=15)) +
  scale_fill_manual(values=c("#FFB64C", "#B1E7C7")) +
  theme(axis.title.x=element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = .5, vjust = 0.5)) +
  labs(title = "C", y=" ") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 1))
meso.mig.bar.3

#two level
meso.mig.summary.2 <- data.frame(
    mean=tapply(meso.mig.long.2$Freq, meso.mig.long.2$meso, mean),
    n=tapply(meso.mig.long.2$Freq, meso.mig.long.2$meso, length),
    sd=tapply(meso.mig.long.2$Freq, meso.mig.long.2$meso, sd)
    )
meso.mig.summary.2 <- setDT(meso.mig.summary.2, keep.rownames = TRUE)[]

meso.mig.summary.2 <- separate(meso.mig.summary.2, rn, 'mesohabitat', sep = " ", remove = FALSE)

meso.mig.summary.2$rn <-  gsub('non-vegetative ', ' ', meso.mig.summary.2$rn)
meso.mig.summary.2$rn <-  gsub('vegetative ', ' ', meso.mig.summary.2$rn)

meso.mig.bar.2 <- ggplot(meso.mig.summary.2, aes(x=mesohabitat, y=mean, fill=rn, position_dodge())) +
  geom_bar(stat = "summary", position = "dodge") +
  geom_errorbar(aes(ymin=0, ymax=mean+sd), position=position_dodge(.9), width = 0) +
  theme_classic() +
  theme(axis.text.x = element_text(size=15)) +
  scale_fill_manual(values=c("#FFB64C", "#B1E7C7")) +
  theme(axis.title.x=element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = .5, vjust = 0.5)) +
  theme(legend.title = element_blank()) + 
  labs(y=' ') +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 1))
meso.mig.bar.2

#behavior
beha.mig.summary <- data.frame(
    mean=tapply(beha.mig.long$Freq, beha.mig.long$behavior, mean),
    n=tapply(beha.mig.long$Freq, beha.mig.long$behavior, length),
    sd=tapply(beha.mig.long$Freq, beha.mig.long$behavior, sd)
    )
beha.mig.summary <- setDT(beha.mig.summary, keep.rownames = TRUE)[]

beha.mig.summary <- separate(beha.mig.summary, rn, 'behavior', sep = " ", remove = FALSE)

beha.mig.summary$rn <-  gsub('Active movement ', ' ', beha.mig.summary$rn)
beha.mig.summary$rn <-  gsub('Cleaning ', ' ', beha.mig.summary$rn)
beha.mig.summary$rn <-  gsub('Feeding ', ' ', beha.mig.summary$rn)
beha.mig.summary$rn <-  gsub('Inactivity ', ' ', beha.mig.summary$rn)
beha.mig.summary$rn <-  gsub('Territorial/mating ', ' ', beha.mig.summary$rn)

beha.mig.bar <- ggplot(beha.mig.summary, aes(x=behavior, y=mean, fill=rn, position_dodge())) +
  geom_bar(stat = "summary", position = "dodge") +
  geom_errorbar(aes(ymin=0, ymax=mean+sd), position=position_dodge(.9), width = 0) +
  theme_classic() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(size=15)) +
  scale_fill_manual(values=c("#FFB64C", "#B1E7C7")) +
  theme(legend.title = element_blank()) +
  theme(axis.title.x=element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = .5, vjust = 0.5)) +
  labs(y=" ") +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 1))
beha.mig.bar


mig.bar <- ggarrange(meso.mig.bar.3, beha.mig.bar, nrow=1, ncol=2)

ssp.fun.bar <- ggarrange(ssp.bar, tro.bar, mig.bar, nrow=3, ncol=1)
ssp.fun.bar
```



###Mesohabitat's influence on Behavior

####Mosiac plots
```{r}
#Chi-squared results can be visualized with mosiac plots

library(ggmosaic)
#three level
cont1 <- site[,c(4, 12, 16, 19)]
cont <- as.data.frame(table(cont1$three.mesohabitat, cont1$broad.behavior))
#two level for mosaic graph
cont1 <- site[,c(4, 12, 16, 18)]
cont.2 <- as.data.frame(table(cont1$two.mesohabitat, cont1$broad.behavior))

#three-level mesohabitat
mos3 <- ggplot(data = cont) +
  geom_mosaic(aes(weight=Freq, x = product(Var2), fill = Var1)) +
  theme_classic() +
  theme(text = element_text(size=20), axis.text.x = element_text(angle = 60, hjust = .5, vjust = 0.5)) +
  labs(x = " ", y = "Microhabitat") +
  theme(legend.title = element_blank()) +
  scale_fill_manual(values=c("#FFB64C", "#B1E7C7", "#F4CFF8")) +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 1))
mos3

#two-level mesohabitat
mos2 <- ggplot(data = cont.2) +
  geom_mosaic(aes(weight=Freq, x = product(Var2), fill = Var1)) +
  theme_classic() +
  theme(text = element_text(size=20), axis.text.x = element_text(angle = 60, hjust = .5, vjust = 0.5)) +
  labs(title = "B", x = "Behavior Type", y = "Mesohabitat") +
  theme(legend.title = element_blank()) +
  scale_fill_manual(values=c("#FFB64C", "#B1E7C7")) +
  theme(panel.border = element_rect(colour = "black", fill = NA, size = 1))
  

mosaic.plot <- ggarrange(mos3, mos2, nrow=2, ncol=1)
mosaic.plot

```



# Models

##Community Structure
Is there a difference in community structure between migration (spring) and breeding (summer) seasons?

###Vegan metrics 

```{r, comm metrics models, warning=FALSE}
#GLMs require 0 and 1's for binary data
#Change "spring" and "summer" to 0 and 1

#test for normality
shapiro.test(cov$abundance) #abundance is normal
shapiro.test(cov$shannon) #shannon is normal
shapiro.test(cov$richness) #richness is NOT normal
shapiro.test(cov$simpson) #simpson is normal
shapiro.test(cov$evenness) #evenness is normal
shapiro.test(cov$turnover) #turnover is normal

#means and standard errors
library(sciplot) #for se
aggregate(cov[, 3:8], list(cov$season), mean)
aggregate(cov[, 3:8], list(cov$season), sciplot::se)



#LMs and GLMs checking for differences between different community structure metrics
#because there are only two predictor levels, we don't need to do post hoc tests

abun.glm <- glm(abundance~season + (1|walk), data=cov, family="quasipoisson") #lm for season's impact on abundance
dispersiontest(abun.glm) #overdispersed as poisson, must used quasipoisson
summary(abun.glm)
#abundance is significantly higher in spring than summer (p < 0.0001)

shan.lm <- lm(shannon~season + (1|walk), data=cov) #lm for season's impact on shannon diversity
summary(shan.lm)
#shannon diversity indices are higher in spring than in summer(p < 0.0001)

rich.glm <- glm(richness~season + (1|walk), data=cov, family="poisson")
summary(rich.glm)
dispersiontest(rich.glm) #poisson is correct not overdispersed
#richness is higher in spring than in summer, but we need to check
anova(rich.glm, test="Chisq")


simp.lm <- lm(simpson~season + (1|walk), data=cov)
summary(simp.lm)
#simpson's diversity is higher in spring than in summer (p < 0.0001)

even.lm <- lm(evenness~season + (1|walk), data=cov)
summary(even.lm) 
#evenness is higher in spring than in summer (p < 0.0001)

turn.lm <- lm(turnover~season + (1|walk), data=cov)
summary(turn.lm)
#turnover is not different between spring and summer (p = 0.9473)

```

###PCA of species for each season

First, we have to collapse our species data into principle components that can be interpretted for explaining variance
```{r, species PCA, echo=FALSE, warning=FALSE}
#PCA's require distance matrices as input
#Let's decide our goal: 80% variance explained.

#Principle Components analysis of spring species
pca1 <- rda(ssp.spring, scale = FALSE)
summary(pca1)

#barplot of relative eigenvalues. This is the percentage variance explained by each axis
pca1bar <- barplot(as.vector(pca1$CA$eig)/sum(pca1$CA$eig)) 
#we can see that 30% of variance is explained by eigenvector 1, ~18% by eigenvector 2, etc.

#Calculate the percent of variance explained by first two, three, four, five, and six axes
sum((as.vector(pca1$CA$eig)/sum(pca1$CA$eig))[1:2]) #46.03%
sum((as.vector(pca1$CA$eig)/sum(pca1$CA$eig))[1:3]) #57.63%
sum((as.vector(pca1$CA$eig)/sum(pca1$CA$eig))[1:4]) #66.85%
sum((as.vector(pca1$CA$eig)/sum(pca1$CA$eig))[1:5]) #74.86%
sum((as.vector(pca1$CA$eig)/sum(pca1$CA$eig))[1:6]) #80.68%
#took us all the way to 6 principle components to reach 80% explaination 

#Now, we`ll plot our results with the plot function
plot(pca1)
plot(pca1, display = "sites", type = "points")
plot(pca1, display = "species", type = "text")

# In a biplot of a PCA, species' scores are drawn as arrows 
# that point in the direction of increasing values for that variable
biplot(pca1, choices = c(1,2), type = c("points", "text", "labels"), xlim = c(-5,10)) # biplot of axis 1 vs 2
biplot(pca1, choices = c(1,3), type = c("points")) # biplot of axis 1 vs 3
biplot(pca1, choices = c(1,4), type = c("points")) # biplot of axis 1 vs 4
biplot(pca1, choices = c(1,6), type = c("point")) #biplot of axis 1 vs 6



#Principle COmponents analysis of Summer species
pca2 <- rda(ssp.summer, scale=FALSE)
summary(pca2)

#barplot of relative eigenvalues. This is the percentage variance explained by each axis
barplot(as.vector(pca2$CA$eig)/sum(pca2$CA$eig)) 
#we can see that 70% of variance is explained by eigenvector 1, ~20% by eigenvector 2, etc.

#Calculate the percent of variance explained by first two, three, and four axes
sum((as.vector(pca2$CA$eig)/sum(pca2$CA$eig))[1:1]) #65.81%
sum((as.vector(pca2$CA$eig)/sum(pca2$CA$eig))[1:2]) #89.24%
sum((as.vector(pca2$CA$eig)/sum(pca2$CA$eig))[1:3]) #93.25%
#we really only needed 2 principle components to reach 80% threshold

#Now, we`ll plot our results with the plot function
plot(pca2)
plot(pca2, display = "sites", type = "points")
plot(pca2, display = "species", type = "text")

# In a biplot of a PCA, species' scores are drawn as arrows 
# that point in the direction of increasing values for that variable
biplot(pca1, choices = c(1,2), type = c("points"), xlim = c(-5,10)) # biplot of axis 1 vs 2
biplot(pca1, choices = c(1,3), type = c("points")) # biplot of axis 1 vs 3

par(mfrow=c(1,2))
biplot(pca1, choices = c(1,6), type = c("point")) #biplot of axis 1 vs 6
biplot(pca1, choices = c(1,2), type = c("points"), xlim = c(-5,10)) # biplot of axis 1 vs 2


#the code we want to use to extract doesn't like vegan, so let's do the same thing with the prcomp() function
pca1.2 <- prcomp(ssp.spring)
#get principle components into datasheet
spring.pc <- get_pca_var(pca1.2) #create object that has pc's (dim1, dim2, etc.)
head(spring.pc$coord) #check it out

#now to do a compatible pca for summer
pca2.2 <- prcomp(ssp.summer)
#get principle components into a datasheet
summer.pc <- get_pca_var(pca2.2) #create object that has pc's
head(summer.pc$coord)


```



##Interaction Opportunties 

###Mesohabitat

First, let's check taxonomic diversity 
```{r, ANOVA of bird mesohabitat use, warning=FALSE}
#now, let's see how our uses of mesohabitat are different for 3 levels of mesohabitat for taxonomic diversity
#summary stats on three level
ddply(meso.ssp.long.3,.(meso),colwise(mean))
ddply(meso.ssp.long.3,.(meso),colwise(sd))

#summary stats on two level
ddply(meso.ssp.long.2,.(meso),colwise(mean))
ddply(meso.ssp.long.2,.(meso),colwise(sd))

#Comparing each mesohabitat in all seasons
#ANOVA on the 3-level mesohabitat
meso3.aov <- aov(Freq ~ meso, data = meso.ssp.long.3)
summary(meso3.aov) #not significant

#ANOVA on the 2-level mesohabitat
meso2.aov <- aov(Freq ~ meso, data = meso.ssp.long.2)
summary(meso2.aov) #not significant

#Comparing each mesohabitat but only within seasons
#three mesohabitat levels
#spring
#summary stats
ddply(meso.ssp.long.3.sp,.(three.mesohabitat),colwise(mean))
ddply(meso.ssp.long.3.sp,.(three.mesohabitat),colwise(sd))
#anova
meso3.aov.sp <- aov(Freq ~ three.mesohabitat, data = meso.ssp.long.3.sp)
summary(meso3.aov.sp) #not significant
#summer
#summary stats
ddply(meso.ssp.long.3.su,.(three.mesohabitat),colwise(mean))
ddply(meso.ssp.long.3.su,.(three.mesohabitat),colwise(sd))
#anova
meso3.aov.su <- aov(Freq ~ three.mesohabitat, data = meso.ssp.long.3.su)
summary(meso3.aov.su) #not significant

#two mesohabitat levels
#spring
#summary stats
ddply(meso.ssp.long.2.sp,.(two.mesohabitat),colwise(mean))
ddply(meso.ssp.long.2.sp,.(two.mesohabitat),colwise(sd))
#anova
meso2.aov.sp <- aov(Freq ~two.mesohabitat, data = meso.ssp.long.2.sp)
summary(meso2.aov.sp) #not significant
#summer
#summary stats
ddply(meso.ssp.long.2.su,.(two.mesohabitat),colwise(mean))
ddply(meso.ssp.long.2.su,.(two.mesohabitat),colwise(sd))
#anova
meso2.aov.su <- aov(Freq ~two.mesohabitat, data = meso.ssp.long.2.su)
summary(meso2.aov.su) #not significant

```

Now, let's check functional diversity. First, trophic guilds.
```{r, ANOVA of bird mesohabitat use, warning=FALSE}
#now, let's see how our uses of mesohabitat are different for 3 levels of mesohabitat for taxonomic diversity
#summary stats on three level
ddply(meso.tro.long.3,.(meso),colwise(mean))
ddply(meso.tro.long.3,.(meso),colwise(sd))

#summary stats on two level
ddply(meso.tro.long.2,.(meso),colwise(mean))
ddply(meso.tro.long.2,.(meso),colwise(sd))

#Comparing each mesohabitat in all seasons
#ANOVA on the 3-level mesohabitat
meso3.aov <- aov(Freq ~ meso, data = meso.tro.long.3)
summary(meso3.aov) #not significant

#ANOVA on the 2-level mesohabitat
meso2.aov <- aov(Freq ~ meso, data = meso.tro.long.2)
summary(meso2.aov) #not significant

#Comparing each mesohabitat but only within seasons
#three mesohabitat levels
#spring
#summary stats
ddply(meso.tro.long.3.sp,.(three.mesohabitat),colwise(mean))
ddply(meso.tro.long.3.sp,.(three.mesohabitat),colwise(sd))
#anova
meso3.aov.sp <- aov(Freq ~ three.mesohabitat, data = meso.tro.long.3.sp)
summary(meso3.aov.sp) #not significant
#summer
#summary stats
ddply(meso.tro.long.3.su,.(three.mesohabitat),colwise(mean))
ddply(meso.tro.long.3.su,.(three.mesohabitat),colwise(sd))
#anova
meso3.aov.su <- aov(Freq ~ three.mesohabitat, data = meso.tro.long.3.su)
summary(meso3.aov.su) #not significant

#two mesohabitat levels
#spring
#summary stats
ddply(meso.tro.long.2.sp,.(two.mesohabitat),colwise(mean))
ddply(meso.tro.long.2.sp,.(two.mesohabitat),colwise(sd))
#anova
meso2.aov.sp <- aov(Freq ~two.mesohabitat, data = meso.tro.long.2.sp)
summary(meso2.aov.sp) #not significant
#summer
#summary stats
ddply(meso.tro.long.2.su,.(two.mesohabitat),colwise(mean))
ddply(meso.tro.long.2.su,.(two.mesohabitat),colwise(sd))
#anova
meso2.aov.su <- aov(Freq ~two.mesohabitat, data = meso.tro.long.2.su)
summary(meso2.aov.su) #not significant

```

Then migratory classes. 
```{r, ANOVA of bird mesohabitat use mig, warning=FALSE}
#now, let's see how our uses of mesohabitat are different for 3 levels of mesohabitat for taxonomic diversity
#summary stats on three level
ddply(meso.mig.long.3,.(meso),colwise(mean))
ddply(meso.mig.long.3,.(meso),colwise(sd))

#summary stats on two level
ddply(meso.mig.long.2,.(meso),colwise(mean))
ddply(meso.mig.long.2,.(meso),colwise(sd))

#Comparing each mesohabitat in all seasons
#ANOVA on the 3-level mesohabitat
meso3.aov <- aov(Freq ~ meso, data = meso.mig.long.3)
summary(meso3.aov) #not significant

#ANOVA on the 2-level mesohabitat
meso2.aov <- aov(Freq ~ meso, data = meso.mig.long.2)
summary(meso2.aov) #not significant

#Comparing each mesohabitat but only within seasons
#three mesohabitat levels
#spring
#summary stats
ddply(meso.mig.long.3.sp,.(three.mesohabitat),colwise(mean))
ddply(meso.mig.long.3.sp,.(three.mesohabitat),colwise(sd))
#anova
meso3.aov.sp <- aov(Freq ~ three.mesohabitat, data = meso.mig.long.3.sp)
summary(meso3.aov.sp) #not significant
#summer
#summary stats
ddply(meso.mig.long.3.su,.(three.mesohabitat),colwise(mean))
ddply(meso.mig.long.3.su,.(three.mesohabitat),colwise(sd))
#anova
meso3.aov.su <- aov(Freq ~ three.mesohabitat, data = meso.mig.long.3.su)
summary(meso3.aov.su) #not significant

#two mesohabitat levels
#spring
#summary stats
ddply(meso.mig.long.2.sp,.(two.mesohabitat),colwise(mean))
ddply(meso.mig.long.2.sp,.(two.mesohabitat),colwise(sd))
#anova
meso2.aov.sp <- aov(Freq ~two.mesohabitat, data = meso.mig.long.2.sp)
summary(meso2.aov.sp) #not significant
#summer
#summary stats
ddply(meso.mig.long.2.su,.(two.mesohabitat),colwise(mean))
ddply(meso.mig.long.2.su,.(two.mesohabitat),colwise(sd))
#anova
meso2.aov.su <- aov(Freq ~two.mesohabitat, data = meso.mig.long.2.su)
summary(meso2.aov.su) #not significant

```


###Behavior
First, let's check taxonomic diversity 

```{r, ANOVA of bird behavior taxo meso, warning=FALSE}
#both seasons together
#summary stats on broad behavior 
ddply(beha.ssp.long,.(behavior),colwise(mean))
ddply(beha.ssp.long,.(behavior),colwise(sd))
#ANOVA on the broad behavior
behavior.aov <- aov(Freq ~ behavior, data = beha.ssp.long)
summary(behavior.aov) #significant, but perhaps way too many 
#posthoc test
TukeyHSD(behavior.aov, conf.level=0.95)
#territorial behavior during spring was the only factor that stood out--it was different from cleaning in both seasons, feeding in both seasons, and inactivity in summer


#spring only
#summary stats
ddply(beha.ssp.long.sp,.(broad.behavior),colwise(mean))
ddply(beha.ssp.long.sp,.(broad.behavior),colwise(sd))
#anova
behavior.aov.sp <- aov(Freq ~ broad.behavior, data = beha.ssp.long.sp)
summary(behavior.aov.sp) #significant
#posthoc test
TukeyHSD(behavior.aov.sp, conf.level=0.95)
#territorial mating-cleaning AND territorial mating-feeding only significant ones


#summer only
#summary stats
ddply(beha.ssp.long.su,.(broad.behavior),colwise(mean))
ddply(beha.ssp.long.su,.(broad.behavior),colwise(sd))
#anova
behavior.aov.su <- aov(Freq ~ broad.behavior, data = beha.ssp.long.su)
summary(behavior.aov.su) #not significant

```

Now, let's check functional diversity. First, trophic guilds.

```{r, ANOVA of bird behavior taxo meso, warning=FALSE}
#both seasons together
#summary stats on broad behavior 
ddply(beha.tro.long,.(behavior),colwise(mean))
ddply(beha.tro.long,.(behavior),colwise(sd))
#ANOVA on the broad behavior
behavior.aov <- aov(Freq ~ behavior, data = beha.tro.long)
summary(behavior.aov) #significant, but perhaps way too many 
#posthoc test
TukeyHSD(behavior.aov, conf.level=0.95)
#territorial behavior during spring was the only factor that stood out--it was different from cleaning in both seasons, feeding in both seasons, and inactivity in summer


#spring only
#summary stats
ddply(beha.tro.long.sp,.(broad.behavior),colwise(mean))
ddply(beha.tro.long.sp,.(broad.behavior),colwise(sd))
#anova
behavior.aov.sp <- aov(Freq ~ broad.behavior, data = beha.tro.long.sp)
summary(behavior.aov.sp) #not significant

#summer only
#summary stats
ddply(beha.tro.long.su,.(broad.behavior),colwise(mean))
ddply(beha.tro.long.su,.(broad.behavior),colwise(sd))
#anova
behavior.aov.su <- aov(Freq ~ broad.behavior, data = beha.tro.long.su)
summary(behavior.aov.su) #not significant

```


Then migratory classes. 

```{r, ANOVA of bird behavior taxo meso, warning=FALSE}
#both seasons together
#summary stats on broad behavior 
ddply(beha.mig.long,.(behavior),colwise(mean))
ddply(beha.mig.long,.(behavior),colwise(sd))
#ANOVA on the broad behavior
behavior.aov <- aov(Freq ~ behavior, data = beha.mig.long)
summary(behavior.aov) #significant, but perhaps way too many 
#posthoc test
TukeyHSD(behavior.aov, conf.level=0.95)
#territorial behavior during spring was the only factor that stood out--it was different from cleaning in both seasons, feeding in both seasons, and inactivity in summer


#spring only
#summary stats
ddply(beha.tro.long.sp,.(broad.behavior),colwise(mean))
ddply(beha.tro.long.sp,.(broad.behavior),colwise(sd))
#anova
behavior.aov.sp <- aov(Freq ~ broad.behavior, data = beha.tro.long.sp)
summary(behavior.aov.sp) #not significant

#summer only
#summary stats
ddply(beha.tro.long.su,.(broad.behavior),colwise(mean))
ddply(beha.tro.long.su,.(broad.behavior),colwise(sd))
#anova
behavior.aov.su <- aov(Freq ~ broad.behavior, data = beha.tro.long.su)
summary(behavior.aov.su) #not significant

```



##Mesohabitats' influence on behavior

```{r, mesohabitats influenc on behavior, warning=FALSE, echo=FALSE}

#first, let's try for both seasons combined
#for ease of access
cont3 <- cont

#chi-squared test of independence
chisq.test(cont) #shows significance, however, there is a warning

#let's try with only two mesohabitats as predictors
cont2 <- as.data.frame(cbind(cont[,"other"], cont[,"cactus"] + cont[,"shrub"]))
chisq.test(cont2) #still shows signficance, however, the warning is still there. I think this is because of the "cleaning" being such a small size. Let's remove cleaning as a response, and try again. 

cont2 <- cont2[-c(2),] #remove cleaning
chisq.test(cont2) #significance! and cell sizes are not too small!

cont3 <- cont3[-c(2),] #remove cleaning
chisq.test(cont3) #significance! and cell sizes are not too small!

#now we must do a posthoc test (bonferroni) to see which pairs are different, starting with 3 meso levels
chisq.posthoc.test(cont3, method = "bonferroni")
#and the same for 2 meso levels
chisq.posthoc.test(cont2, method = "bonferroni")

#now let's try spring
#for ease of access
cont.sp3 <- cont.sp

#chi-squared test of independence
chisq.test(cont.sp) #shows significance, however, there is a warning

#let's try with only two mesohabitats as predictors
cont.sp2 <- as.data.frame(cbind(cont.sp[,"other"], cont.sp[,"cactus"] + cont.sp[,"shrub"]))
chisq.test(cont.sp2) #still shows signficance, however, the warning is still there. I think this is because of the "cleaning" being such a small size. Let's remove cleaning as a response, and try again. 

cont.sp2 <- cont.sp2[-c(2),] #remove cleaning
chisq.test(cont.sp2) #significance! and cell sizes are not too small!

cont.sp3 <- cont.sp3[-c(2),] #remove cleaning
chisq.test(cont.sp3) #significance! and cell sizes are not too small!

#now we must do a posthoc test (bonferroni) to see which pairs are different, starting with 3 meso levels
chisq.posthoc.test(cont.sp3, method = "bonferroni")
#and the same for 2 meso levels
chisq.posthoc.test(cont.sp2, method = "bonferroni")


#now let's try summer
#for ease of access
cont.su3 <- cont.su

#chi-squared test of independence
chisq.test(cont.su) #shows significance, however, there is a warning

#let's try with only two mesohabitats as predictors
cont.su2 <- as.data.frame(cbind(cont.su[,"other"], cont.su[,"cactus"] + cont.su[,"shrub"]))
chisq.test(cont.su2) #still shows signficance, however, the warning is still there. I think this is because of the "cleaning" being such a small size. Let's remove cleaning as a response, and try again. 

cont.su2 <- cont.su2[-c(2),] #remove cleaning
chisq.test(cont.su2) #significance! and cell sizes are not too small!

cont.su3 <- cont.su3[-c(2),] #remove cleaning
chisq.test(cont.su3) #significance! and cell sizes are not too small!

#now we must do a posthoc test (bonferroni) to see which pairs are different, starting with 3 meso levels
chisq.posthoc.test(cont.su3, method = "bonferroni")
#and the same for 2 meso levels
chisq.posthoc.test(cont.su2, method = "bonferroni")



```

