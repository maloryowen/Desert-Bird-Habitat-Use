---
title: "Stats"
author: "Malory Owen & Christopher Lortie"
date: "4/24/2020"
output:
  pdf_document: default
  html_document: default
  word_document: default
---

#Foundation plants and avian community associations
A set of survey data to examine key desert plant species associations with avian community structure and composition.

Hypothesis:
There are associations between birds and foundation plant species such as shrubs and cacti, and these relationships change with phenology.

Predictions:
1. Abundance and diversity of birds is greater near foundation plant species.
2. Spring and summer seasons change the associations between the foundation plants and avian community.
3. Behaviour and functional diversity of the avian species also differ when in association with foundation plant species relative to open microsites.


#Data
```{r, Data, warning=FALSE, include=FALSE, echo=FALSE}
library(tidyverse)
library(lubridate)
data <- read_csv("~/Masters/Desert-Bird-Habitat-Use/data/line_transects_viz.csv")
tidy_data <- data %>%
  rename(rep = bird.id, survey = walk, long = lon, migratory_class = migratory.class, guild = trophic.guild, behavior_simple = broad.behavior, microhabitat = three.mesohabitat) %>%
  mutate(date = mdy(date)) %>%
  mutate(day = mday(date)) 

#take a peek at tidy data then select key vectors

tidy_data <- tidy_data %>%
  select(rep, date, season, day, survey, microhabitat, family, species, migratory_class, guild, behavior_simple, month.day.hour) %>%
  mutate(microhabitat = case_when(microhabitat == "other" ~ "open", TRUE ~ as.character(microhabitat)))
write_csv(tidy_data, "~/Masters/Desert-Bird-Habitat-Use/data/tidy_data.csv")

#weather data
weather <- read_csv("~/Masters/Desert-Bird-Habitat-Use/weather/weather.csv") %>% 
  select(month.day.hour, Air.Temperature.Mean.Deg.F)

#join mean air temperature for the hour to tidy data
tidy_data <- left_join(tidy_data, weather, by = 'month.day.hour') %>% 
  rename(temp = Air.Temperature.Mean.Deg.F)

#taxanomic model datasets
  
data_species <- tidy_data %>%
  group_by(season, survey, microhabitat, species, temp) %>%
  summarise(counts = n()) 

data_richness <- data_species %>%
  group_by(season, survey, microhabitat, temp) %>%
  summarise(richness = n())

data_behavior <- tidy_data %>%
  group_by(season, survey, microhabitat, behavior_simple, temp) %>%
  summarise(totals = n())

#trophic guild model dataset
data_trophic <- tidy_data %>% 
  group_by(season, survey, microhabitat, guild, temp) %>% 
  summarise(counts = n()) %>% 
  filter(guild != 'Unknown') %>% 
  filter(guild != "unknown")

#migratory class model dataset
data_migratory <- tidy_data %>% 
  group_by(season, survey, microhabitat, migratory_class, temp) %>% 
  summarise(counts = n()) %>% 
  filter(migratory_class != "unknown")


#Black-throated Sparrow
data_sparrow <- tidy_data %>%
  group_by(season, survey, microhabitat, species, behavior_simple, temp) %>%
  summarise(counts = n()) %>% 
  filter(species == "Black.throated Sparrow")

```


#Viz
```{r}
box1 <- ggplot(data_species, aes(season, counts, color = microhabitat, fill = microhabitat)) +
  geom_boxplot() +
  scale_color_brewer(palette = "Set1") +
  scale_fill_manual(values=c("#DAF7A6", "#FFD156", "#CF92D5")) +
  labs(y = "Species Abundance", x= " ", title = "A") +
  theme_classic(base_size = 15) +
  theme(legend.position = "none") +
  theme(axis.text=element_text(size=15))

box2 <- ggplot(data_species, aes(season, counts, color = microhabitat)) +
  geom_jitter() +
  scale_color_brewer(palette = "Set1") +
  labs(y = "abundance") +
  facet_wrap(~species) +
  labs(y = "abundance")

box3 <- ggplot(data_richness, aes(season, richness, color = microhabitat, fill = microhabitat)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#DAF7A6", "#FFD156", "#CF92D5")) +
  scale_color_brewer(palette = "Set1") +
  labs(y="Species Richness", x=" ", title = "B") +
  theme_classic(base_size = 15) +
  theme(legend.title = element_blank()) +
  theme(axis.text = element_text(size=15))


ggarrange(box1, box3, ncol=1, nrow=2)


box4 <- ggplot(data_behavior, aes(season, totals, color = microhabitat, fill = microhabitat)) +
  geom_boxplot() +
  scale_color_brewer(palette = "Set1") +
  scale_fill_manual(values=c("#DAF7A6", "#FFD156", "#CF92D5")) +
  facet_wrap(~behavior_simple, ncol = 2) +
  labs(y = "Species Frequency", x = " ") +
  theme_classic(base_size = 15) +
  theme(legend.position = "bottom") +
  theme(axis.text = element_text(size=15))
box4

box5 <- ggplot(data_trophic, aes(season, counts, color = microhabitat, fill = microhabitat)) +
  geom_boxplot() +
  scale_color_brewer(palette = "Set1") +
  scale_fill_manual(values=c("#DAF7A6", "#FFD156", "#CF92D5")) +
  labs(y = "Trophic Guild Abundance", x= " ", title = "A") +
  theme_classic(base_size = 15) +
  theme(legend.position = "none") +
  theme(axis.text = element_text(size=15))

box6 <- ggplot(data_migratory, aes(season, counts, color = microhabitat, fill = microhabitat)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#DAF7A6", "#FFD156", "#CF92D5")) +
  scale_color_brewer(palette = "Set1") +
  labs(y="Migratory Class Abundance", x="Season", title = "B") +
  theme_classic(base_size = 15) +
  theme(legend.title = element_blank()) +
  theme(axis.text = element_text(size=15))

ggarrange(box5, box6, ncol=1, nrow=2)

sparrow <- ggplot(data_sparrow, aes(season, counts, color = microhabitat, fill = microhabitat)) +
  geom_boxplot() +
  scale_color_brewer(palette = "Set1") +
  scale_fill_manual(values=c("#DAF7A6", "#FFD156", "#CF92D5")) +
  labs(y="BTSP Abundance", x= "Season") +
  facet_wrap(~behavior_simple, ncol=2) +
  theme_classic(base_size = 15) +
  theme(legend.title = element_blank()) +
  theme(axis.text = element_text(size=15))
sparrow

```



#Models

##Microhabitat, behavior, and season
```{r}
library(emmeans)
library(AER)


m1a <- glm(counts~microhabitat*season + (1 |survey) + (1|temp), family = quasipoisson, data = data_species)
anova(m1a, test = "Chisq")
summary(m1a) #not overdispersed when quasipoisson
dispersiontest(m1a, trafo=1) #overdispersed as poisson

c1a <- emmeans(m1a, pairwise~microhabitat*season)
c1a


m1b <- glm(counts~species*microhabitat*season + (1 |survey) + (1|temp), family = quasipoisson, data = data_species)
anova(m1b, test = "Chisq")

c1b <- emmeans(m1b, pairwise~species*microhabitat*season)
c1b

m2 <- glm(richness~microhabitat*season + (1 |survey) + (1|temp), family = gaussian, data = data_richness)
anova(m2, test = "Chisq")
summary(m2) #not overdispered as gaussian

c2 <- emmeans(m2, pairwise~microhabitat*season)
c2


m3 <- glm(totals~microhabitat*behavior_simple + (1|survey) + (temp), family = quasipoisson, data = data_behavior)
anova(m3, test = "Chisq")
summary(m3) #not overdispersed as quasipoisson

c3 <- emmeans(m3, pairwise~microhabitat*behavior_simple)
c3

m3b <- glm(totals~microhabitat*season*behavior_simple + (1|survey) + (1|temp), family = quasipoisson, data = data_behavior)
summary(m3b) #not overdispersed as quasipoisson
anova(m3, test = "Chisq")

c3b <- emmeans(m3b, pairwise~microhabitat*season*behavior_simple)
c3b

#Trophic Guilds as diversity metrics
m4 <- glm(counts~microhabitat*season + (1 |survey) + (1|temp), family = quasipoisson, data = data_trophic)
summary(m4) #not overdispersed as quasipoisson
dispersiontest(m4, trafo=1) #overdispersed as poisson
anova(m4, test = "Chisq")

c4 <- emmeans(m4, pairwise~microhabitat*season)
c4

m4b <- glm(counts~guild*microhabitat*season + (1 |survey) + (1|temp), family = quasipoisson, data = data_trophic)
summary(m4b) #not overdispersed as quasipoisson
anova(m4b, test = "Chisq")

c4b <- emmeans(m4b, pairwise~guild*microhabitat*season)
c4b

#Migratory classes at diversity metrics
m5 <- glm(counts~microhabitat*season + (1 |survey) + (1|temp), family = quasipoisson, data = data_migratory)
summary(m5) #not overdispersed as quasipoisson
anova(m5, test = "Chisq")

c5 <- emmeans(m5, pairwise~microhabitat*season)
c5


m5b <- glm(counts~migratory_class*microhabitat*season + (1 |survey) + (1|temp), family = quasipoisson, data = data_migratory)
anova(m5b, test = "Chisq")

c5b <- emmeans(m5b, pairwise~migratory_class*microhabitat*season)
c5b


#Black-throated Sparrows only
m6 <- glm(counts~microhabitat*season*behavior_simple + (1|survey) + (1|temp), family = quasipoisson, data = data_sparrow)
dispersiontest(m6)
summary(m6) #not overdispersed as quasipoisson
anova(m6, test = "Chisq")

c6 <- emmeans(m6, pairwise~microhabitat*season*behavior_simple)
c6


```

